steps:
  # Step 1: Build the image from latest base
  - name: gcr.io/cloud-builders/docker
    id: Build Image
    args: [
      "build",
      "--no-cache",
      "-t", "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:staging",
      "."
    ]

  # Step 2: Push the staging image
  - name: gcr.io/cloud-builders/docker
    id: Push Image
    args: [
      "push",
      "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:staging"
    ]

  # Step 3: Run validation tests (e.g. dbt test)
  - name: asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:staging
    id: Run DBT Tests
    entrypoint: bash
    args:
      - -c
      - |
        mkdir -p /builder/home/.dbt
        cat > /builder/home/.dbt/profiles.yml <<EOF
        heymax_dbt_data_tables:
          target: dev
          outputs:
            dev:
              type: bigquery
              method: oauth
              project: heymax-kelvin-analytics
              dataset: heymax_analytics
              location: US
              threads: 4
        EOF

        cd /workspace
        ls -al
        dbt deps --profiles-dir /builder/home/.dbt
        dbt seed --profiles-dir /builder/home/.dbt
        dbt run --profiles-dir /builder/home/.dbt
        dbt test --profiles-dir /builder/home/.dbt

  # Step 4: Promote image to prod only if tests succeed
  - name: gcr.io/cloud-builders/docker
    id: Promote to Prod
    args: [
      "tag",
      "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:staging",
      "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:prod"
    ]

  - name: gcr.io/cloud-builders/docker
    id: Push Prod Image
    args: [
      "push",
      "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:prod"
    ]

images:
  - "asia-southeast1-docker.pkg.dev/heymax-kelvin-analytics/dbt-images/dbt-runner:prod"
